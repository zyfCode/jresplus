(function(win){var globalEval=function globalEval(src){if(window.execScript){window.execScript(src);return}var fn=function(){window.eval.call(window,src)};fn()};var _BigPipeUtil={apply:function(fn,scope){return(function(){return fn.apply(scope,arguments)})}};var _BigPipeHash=function(){var _cache={};var _size=0;return{set:function(id,value){if(id){_cache[id]=value;_size++}},get:function(id){if(id){return _cache[id]}},size:function(){return _size},each:function(iterator){for(var key in _cache){var value=_cache[key],pair=[key,value];pair.key=key;pair.value=value;iterator(pair)}}}};function PageletResource(file,name,type){this.initialize(file,name,type)}PageletResource.prototype={name:null,file:null,type:null,phase:0,belongs:null,initialize:function(file,name,type){this.name=name;this.file=file;this.type=type;this.belongs=new Array();BigPipe.debug("Pagelet "+name+" created as type "+type+" with file ",file)},getHeadElement:function(){var tagArr=document.getElementsByTagName("head");if(tagArr&&tagArr.length>0){return tagArr[0]}},attachToPagelet:function(callback){this.belongs.push(callback)},startLoading:function(){var _scope=this;if(this.phase!=0){return}BigPipe.debug("Started loading "+this.type+" resource:",this.file);if(this.type=="css"){var ref=document.createElement("link");ref.setAttribute("rel","stylesheet");ref.setAttribute("type","text/css");ref.setAttribute("href",this.file);ref.onload=function(){_scope.phase=1;_scope.onComplete()};var headEl=this.getHeadElement();if(headEl){headEl.appendChild(ref)}}if(this.type=="js"){var js=document.createElement("script");js.setAttribute("type","text/javascript");js.setAttribute("src",this.file);js.onload=js.onreadystatechange=function(){if(!this.readyState||this.readyState=="loaded"||this.readyState=="complete"){_scope.phase=1;_scope.onComplete()}};var headEl=this.getHeadElement();if(headEl){headEl.appendChild(js)}}},onComplete:function(){if(this.phase==2){return}this.phase=2;for(var i=0;i<this.belongs.length;i++){this.belongs[i](this)}}};function Pagelet(data){this.initialize(data)}Pagelet.prototype={jsCode:null,cssResources:null,jsResources:null,id:"",innerHTML:"",json:null,phase:0,initialize:function(json){this.id=json.id;this.phase=0;this.json=json;this.jsCode=json.jsCode;this.cssResources=new _BigPipeHash();this.jsResources=new _BigPipeHash();this.innerHTML=json.html},start:function(){for(var i=0;i<this.json.css.length;i++){var cssResource=BigPipe.pageletResourceFactory(this.json.css[i],"css");this.attachCssResource(cssResource)}for(var i=0;i<this.json.js.length;i++){var jsResource=BigPipe.pageletResourceFactory(this.json.js[i],"js");this.attachJsResource(jsResource)}this.cssResources.each(function(pair){this.phase=1;pair.value.startLoading()});if(this.phase==0){this.injectInnerHTML()}},attachCssResource:function(resource){BigPipe.debug("Attaching CSS resource "+resource.file+" to pagelet "+this.id,null);resource.attachToPagelet(_BigPipeUtil.apply(this.onCssOnload,this));this.cssResources.set(resource.file,resource)},attachJsResource:function(resource){BigPipe.debug("Attaching JS resource "+resource.file+" to pagelet "+this.id,null);resource.attachToPagelet(_BigPipeUtil.apply(this.onJsOnload,this));this.jsResources.set(resource.file,resource)},onJsOnload:function(x){if(this.phase>3){return}var allLoaded=true;this.jsResources.each(function(pair){if(pair.value.phase!=2){allLoaded=false}});if(!allLoaded){return}if(this.jsResources.size()>0){BigPipe.debug("pagelet "+this.id+": All JS resources are loaded")}if(this.jsCode&&this.jsCode!=""){try{BigPipe.debug("evaluating js code: ",this.jsCode);globalEval(this.jsCode)}catch(e){BigPipe.debug("Error while evaluating "+x,e)}}this.phase=4},onCssOnload:function(x){BigPipe.debug("pagelet "+this.id+" got notified that CSS resource is loaded: ",x);var allLoaded=true;this.cssResources.each(function(pair){if(pair.value.phase!=2){allLoaded=false}});if(!allLoaded){return}BigPipe.debug("all resources loaded",this);this.injectInnerHTML()},injectInnerHTML:function(){this.phase=2;var div=document.getElementById(this.id);BigPipe.debug("injecting innerHTML to "+this.id,this);if(div!=null&&typeof this.innerHTML=="string"&&this.innerHTML!=""){div.innerHTML=this.innerHTML}this.phase=3;BigPipe.pageletHTMLInjected(this)}};win.BigPipe={pageletResources:new _BigPipeHash(),pagelets:new _BigPipeHash(),phase:0,debug_:true,onArrive:function(data){this.debug("Pagelet arrived: ",data);if(data.isLast!=undefined&&data.isLast){this.debug("This pagelet was last:",data);this.phase=1}var pagelet=new Pagelet(data);this.pagelets.set(pagelet.id,pagelet);pagelet.start()},start:function(){this.loadJSResources()},fileLoaded:function(filename){var resource=this.pageletResources.get(filename);BigPipe.debug("js file loaded",filename);if(resource){resource.onComplete()}},pageletHTMLInjected:function(pagelet){var allLoaded=true;this.debug("pageletHTMLInjected",pagelet);this.pagelets.each(_BigPipeUtil.apply(function(pair){if(pair.value.phase<3){this.debug("pageletHTMLInjected pagelet still not loaded",pair.value);allLoaded=false}},this));if(!allLoaded){return}if(this.phase==1){this.loadJSResources()}},loadJSResources:function(){this.phase=2;this.debug("Starting to load js resources...");var something_started=false;this.pageletResources.each(function(pair){if(pair.value.type=="js"){something_started=true;pair.value.startLoading()}});this.pagelets.each(_BigPipeUtil.apply(function(pair){if(pair.value.jsResources.size()>0){pair.value.onJsOnload()}},this));if(!something_started){this.debug("No js resources in page, moving forward...");this.pagelets.each(_BigPipeUtil.apply(function(pair){pair.value.onJsOnload()},this))}},debug:function(funcName,data){if(BigPipe.debug_&&typeof console!="undefined"&&typeof console.log!="undefined"){console.log("BigPipe."+funcName,data)}},pageletResourceFactory:function(file,type){var re=new RegExp("(?:.*/)?(.+js)");var m=re.exec(file);var name=file;if(m){name=m[1]}var res=this.pageletResources.get(name);if(!res){res=new PageletResource(file,name,type);this.pageletResources.set(name,res)}return res},loadResource:function(obj){var type="",target="";bpObj={html:"",id:new Date().getTime(),css:[],js:[],jsCode:""};if(typeof obj=="string"){var arr=obj.split(".");type=arr.pop();target=obj}else{type=obj.type;target=obj.target}type=type.toLowerCase();if(type=="css"){bpObj.css.push(target);this.onArrive(bpObj)}else{if(type=="js"){bpObj.js.push(target);this.onArrive(bpObj);this.start()}else{bpObj.jsCode=target;this.onArrive(bpObj);this.start()}}}}})(window);